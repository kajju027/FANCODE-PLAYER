<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CNP FANCODE LIVE Plyr Player</title>
  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
  <style>
    body { background: #222; color: #fff; text-align: center; margin:0; padding:0; font-family: Arial,sans-serif;}
    .live-title {
      font-size: 1.1em;
      color: #ffd700;
      background: rgba(0,0,0,0.75);
      padding: 6px 0;
      margin: 0;
      letter-spacing: 2px;
      font-weight: bold;
      width: 100vw;
      max-width: 100vw;
      position:relative;
      z-index:2;
      box-shadow:0 2px 2px rgba(0,0,0,0.07);
    }
    .player-container {
      max-width: 99vw;
      margin: 0 auto;
      padding: 0;
      position:relative;
      z-index:1;
    }
    video {
      width: 100vw;
      max-width: 700px;
      min-width: 220px;
      height: 56vw;         /* 16:9 ratio for mobile */
      max-height: 70vh;
      background: #000;
      border: none;
      outline: none;
      display: block;
      margin: 0 auto;
    }
    @media (min-width: 700px) {
      video {
        height: 392px;
      }
    }
    @media (max-width:500px) {
      .live-title { font-size: 0.95em; padding: 5px 0;}
      video { min-width: 100vw; }
    }
  </style>
</head>
<body>
  <div class="live-title">CNP FANCODE LIVE</div>
  <div class="player-container">
    <video id="player" controls playsinline poster="" preload="none"></video>
  </div>
  <!-- Plyr & HLS.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <script>
    function getM3U8Link() {
      const params = new URLSearchParams(window.location.search);
      return params.get('i');
    }

    const video = document.getElementById('player');
    const m3u8Url = getM3U8Link();

    // Plyr init
    const plyrOptions = {
      controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
      settings: ['quality'],
      quality: {
        default: 240,
        options: [],
        forced: true,
        onChange: (quality) => {
          if (window.hls && window.hls.levels) {
            const level = window.hls.levels.findIndex(lvl => lvl.height === quality);
            window.hls.currentLevel = level;
          }
        }
      }
    };
    const player = new Plyr(video, plyrOptions);

    if (m3u8Url && m3u8Url.endsWith('.m3u8')) {
      if (Hls.isSupported()) {
        window.hls = new Hls();
        window.hls.loadSource(m3u8Url);
        window.hls.attachMedia(video);
        window.hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
          // Collect all qualities
          const availableQualities = window.hls.levels.map(lvl => lvl.height).sort((a, b) => a - b);
          // Remove duplicate qualities
          const uniqueQualities = [...new Set(availableQualities)];
          player.options.quality.options = uniqueQualities;
          player.quality = uniqueQualities.includes(240) ? 240 : uniqueQualities[0];

          // Update Plyr quality menu
          player.config.quality.options = uniqueQualities;

          // Set default quality
          const level240 = window.hls.levels.findIndex(lvl => lvl.height === 240);
          window.hls.currentLevel = level240 !== -1 ? level240 : 0;
        });

        // Quality change sync
        player.on('qualitychange', event => {
          let newQuality = event.detail.plyr.quality;
          let level = window.hls.levels.findIndex(lvl => lvl.height === newQuality);
          window.hls.currentLevel = level;
        });

      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = m3u8Url;
      } else {
        alert("দুঃখিত, আপনার ব্রাউজার ভিডিও ফরম্যাট সাপোর্ট করেনা।");
      }
    } else {
      // No video source, so remove video src if any
      video.removeAttribute('src');
      if (window.hls) window.hls.detachMedia();
    }
  </script>
</body>
  </html>
  
