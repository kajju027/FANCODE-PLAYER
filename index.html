<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>CNP FANCODE LIVE </title>
  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
  <style>
    body { background: #222; color: #fff; text-align: center; }
    .player-container { position: relative; max-width: 700px; margin: 40px auto; }
    .live-banner {
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 2rem;
      z-index: 10;
      transition: opacity 0.5s;
    }
    video { width: 100%; background: #000; }
  </style>
</head>
<body>
  <h1 style="margin-bottom:10px;">FANCODE LIVE BY CNP</h1>
  <div class="player-container">
    <div class="live-banner" id="liveBanner">CNP FANCODE LIVE</div>
    <video id="player" controls playsinline poster="" preload="none"></video>
  </div>

  <!-- Plyr & HLS.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
  <script>
    function getM3U8Link() {
      const params = new URLSearchParams(window.location.search);
      return params.get('i');
    }

    const video = document.getElementById('player');
    const banner = document.getElementById('liveBanner');
    const m3u8Url = getM3U8Link();

    // Plyr init
    const plyrOptions = {
      controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
      settings: ['quality'],
      quality: {
        default: 240,
        options: [],
        forced: true,
        onChange: (quality) => {
          if (window.hls && window.hls.levels) {
            const level = window.hls.levels.findIndex(lvl => lvl.height === quality);
            window.hls.currentLevel = level;
          }
        }
      }
    };
    const player = new Plyr(video, plyrOptions);

    if (m3u8Url && m3u8Url.endsWith('.m3u8')) {
      if (Hls.isSupported()) {
        window.hls = new Hls();
        window.hls.loadSource(m3u8Url);
        window.hls.attachMedia(video);
        window.hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
          // Collect all qualities
          const availableQualities = window.hls.levels.map(lvl => lvl.height).sort((a, b) => a - b);
          // Remove duplicate qualities
          const uniqueQualities = [...new Set(availableQualities)];
          player.options.quality.options = uniqueQualities;
          player.quality = uniqueQualities.includes(240) ? 240 : uniqueQualities[0];

          // Update Plyr quality menu
          player.config.quality.options = uniqueQualities;

          // Set default quality
          const level240 = window.hls.levels.findIndex(lvl => lvl.height === 240);
          window.hls.currentLevel = level240 !== -1 ? level240 : 0;
        });

        // Hide banner on play
        video.addEventListener('play', function() {
          banner.style.opacity = 0;
          setTimeout(()=>banner.style.display="none",500);
        });

        // Show banner if paused or ended
        video.addEventListener('pause', function() {
          banner.style.display = "flex";
          setTimeout(()=>banner.style.opacity = 1,10);
        });
        video.addEventListener('ended', function() {
          banner.style.display = "flex";
          setTimeout(()=>banner.style.opacity = 1,10);
        });

        // Quality change sync
        player.on('qualitychange', event => {
          let newQuality = event.detail.plyr.quality;
          let level = window.hls.levels.findIndex(lvl => lvl.height === newQuality);
          window.hls.currentLevel = level;
        });

      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = m3u8Url;
        video.addEventListener('play', function() {
          banner.style.opacity = 0;
          setTimeout(()=>banner.style.display="none",500);
        });
        video.addEventListener('pause', function() {
          banner.style.display = "flex";
          setTimeout(()=>banner.style.opacity = 1,10);
        });
        video.addEventListener('ended', function() {
          banner.style.display = "flex";
          setTimeout(()=>banner.style.opacity = 1,10);
        });
      } else {
        banner.innerHTML = "দুঃখিত, আপনার ব্রাউজার ভিডিও ফরম্যাট সাপোর্ট করেনা।";
      }
    } else {
      // No video source, so show banner and do nothing else
      banner.style.display = "flex";
      banner.style.opacity = 1;
      // Remove video src if any
      video.removeAttribute('src');
      if (window.hls) window.hls.detachMedia();
    }
  </script>
</body>
</html>
